// Prisma Schema for IDP Authentication System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - represents authenticated users
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  avatar    String?
  provider  String   // "google", "github", etc.
  providerId String  // OAuth provider ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizations UserOrganization[]
  tenants       UserTenant[]
  createdInvitations Invitation[] @relation("InvitationCreatedBy")
  accounts      Account[]
  auditLogs     AuditLog[]

  @@unique([provider, providerId])
  @@index([email])
}

// Account model - linked OAuth accounts
model Account {
  id        String   @id @default(cuid())
  userId    String
  provider  String
  providerId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@unique([userId, provider])
  @@index([userId])
}

// Organization model - top-level grouping
model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logoUrl     String?
  settings    Json?    // Store flexible settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     UserOrganization[]
  tenants     Tenant[]
  invitations Invitation[]
  auditLogs   AuditLog[]
  blueprints  Blueprint[]
  integrationConfigs IntegrationConfig[]

  @@index([slug])
}

// Tenant model - workspaces/environments within an organization
model Tenant {
  id             String   @id @default(cuid())
  name           String
  slug           String
  description    String?
  organizationId String
  isDefault      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users        UserTenant[]
  blueprints   Blueprint[]
  integrationConfigs IntegrationConfig[]

  @@unique([organizationId, slug])
  @@index([organizationId])
}

// Join table for User-Organization relationship with roles
model UserOrganization {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  role           String   @default("member") // "owner", "admin", "member"
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

// Join table for User-Tenant relationship
model UserTenant {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String
  role      String   @default("member") // tenant-level permissions
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
}

// Invitation model for inviting users to organizations
model Invitation {
  id             String   @id @default(cuid())
  email          String
  organizationId String
  role           String   @default("member")
  token          String   @unique
  status         String   @default("pending") // "pending", "accepted", "expired", "revoked"
  expiresAt      DateTime
  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("InvitationCreatedBy", fields: [createdById], references: [id])

  @@index([email])
  @@index([token])
  @@index([organizationId])
}

// Blueprint model - Port.io compatible structure
model Blueprint {
  id                    String   @id @default(cuid())
  identifier            String
  title                 String
  icon                  String?
  description           String?
  
  // Schema definition (properties and required fields)
  schema                Json     @default("{}")
  
  // Advanced property types
  mirrorProperties       Json @default("{}")
  calculationProperties  Json @default("{}")
  aggregationProperties  Json @default("{}")
  
  // Relations to other blueprints
  relations   Json     @default("{}")
  
  changelogDestination   Json?    // Changelog tracking configuration
  
  // Audit fields
  createdAt   DateTime @default(now())
  createdBy   String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  // Multi-tenancy
  organizationId String?
  tenantId       String?

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tenant         Tenant?       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Ensure identifier is unique per tenant/organization scope
  // Note: NULL values in unique indexes are treated as distinct in SQL standard, 
  // but Prisma/DB specific behavior varies. 
  // For now, assuming standard uniqueness scoping.
  @@unique([identifier, organizationId, tenantId])
  @@index([identifier])
  @@index([organizationId])
  @@index([tenantId])
}

// Entity model - Port.io compatible entity structure
model Entity {
  id             String   @id @default(cuid())
  identifier     String   // User-defined identifier
  blueprintId    String   // Blueprint identifier this entity belongs to
  title          String?  // Display title

  // Entity data (properties)
  properties     Json     @default("{}")

  // Relations to other entities
  relations      Json     @default("{}")

  // Metadata
  team           String?  // Team/group ownership
  icon           String?  // Icon override

  // Audit fields
  createdAt      DateTime @default(now())
  createdBy      String?
  updatedAt      DateTime @updatedAt
  updatedBy      String?

  // Multi-tenancy
  organizationId String?
  tenantId       String?

  // History tracking
  history        EntityHistory[]

  @@unique([identifier, blueprintId, organizationId, tenantId])
  @@index([blueprintId])
  @@index([identifier])
  @@index([organizationId])
  @@index([tenantId])
  @@index([createdAt])
  @@index([updatedAt])
}

// EntityHistory model - tracks changes to entity properties over time
model EntityHistory {
  id             String   @id @default(cuid())
  entityId       String
  blueprintId    String
  entityIdentifier String

  // Changed data
  propertyName   String?  // Specific property that changed (null for full entity updates)
  oldValue       Json?    // Previous value
  newValue       Json?    // New value

  // Change metadata
  changeType     String   // "CREATE", "UPDATE", "DELETE", "PROPERTY_UPDATE"
  changedAt      DateTime @default(now())
  changedBy      String?

  // Snapshot of entity at this point in time
  snapshot       Json     // Full entity state at this time

  // Multi-tenancy
  organizationId String?
  tenantId       String?

  // Relations
  entity         Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityId])
  @@index([blueprintId])
  @@index([entityIdentifier])
  @@index([propertyName])
  @@index([changedAt])
  @@index([organizationId])
  @@index([tenantId])
}

// CatalogFolder model - hierarchical folder structure for organizing catalog pages
model CatalogFolder {
  id             String   @id @default(cuid())
  title          String
  description    String?

  // Hierarchy
  parentId       String?
  parent         CatalogFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children       CatalogFolder[] @relation("FolderHierarchy")

  // Ordering
  order          Int      @default(0)

  // Audit fields
  createdAt      DateTime @default(now())
  createdBy      String?
  updatedAt      DateTime @updatedAt
  updatedBy      String?

  // Multi-tenancy
  organizationId String
  tenantId       String?

  // Relations
  pages          CatalogPage[]

  @@index([organizationId])
  @@index([tenantId])
  @@index([parentId])
  @@index([order])
}

// CatalogPage model - pages that display entities from a blueprint
model CatalogPage {
  id             String   @id @default(cuid())
  title          String
  icon           String?
  description    String?

  // Blueprint association
  blueprintId    String

  // Folder association
  folderId       String?
  folder         CatalogFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  // Page configuration
  layout         String   @default("table") // "table", "grid", "list"
  filters        Json     @default("{}") // Default filters for the page
  columns        Json     @default("[]") // Visible columns configuration
  sortBy         String?  // Default sort field
  sortOrder      String?  // "asc" or "desc"

  // Ordering
  order          Int      @default(0)

  // Visibility
  isPublic       Boolean  @default(true)

  // Audit fields
  createdAt      DateTime @default(now())
  createdBy      String?
  updatedAt      DateTime @updatedAt
  updatedBy      String?

  // Multi-tenancy
  organizationId String
  tenantId       String?

  @@index([organizationId])
  @@index([tenantId])
  @@index([blueprintId])
  @@index([folderId])
  @@index([order])
}

// AuditLog model - tracks all system actions
model AuditLog {
  id             String   @id @default(cuid())
  identifier     String   @unique
  action         String   // "CREATE", "UPDATE", "DELETE"
  resourceType   String   // "blueprint", "entity", "user", "organization", etc.
  status         String   // "SUCCESS", "FAILURE"
  message        String?  // Error message if failed

  // Trigger information
  triggeredAt    DateTime @default(now())
  triggeredBy    Json     // { appId?, userId?, orgId? }
  origin         String   // "API", "UI", "SYSTEM"

  // Context information
  context        Json?    // Resource-specific data (blueprintId, entityId, etc.)
  additionalData Json?    // Extra metadata

  // Relations
  organizationId String?
  userId         String?

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([resourceType])
  @@index([action])
  @@index([triggeredAt])
  @@index([status])
}

// Integration Configuration (e.g. GitHub Mapping)
model IntegrationConfig {
  id             String   @id @default(cuid())
  provider       String   // "github", "gitlab", etc.
  installationId String?  @unique // GitHub App Installation ID
  mappingYaml    String   @db.Text // YAML string for mapping rules
  
  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  tenantId       String?
  tenant         Tenant?      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@unique([organizationId, provider, tenantId])
  @@index([organizationId])
  @@index([tenantId])
}
